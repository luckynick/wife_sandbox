name: Deploy to GitHub Pages

on:
  push:
    branches:
      - main
      - 'claude/**'
  workflow_dispatch:

permissions:
  contents: write
  pages: write
  id-token: write

# Use a single concurrency group for all deployments to prevent race conditions
concurrency:
  group: "pages-deployment"
  cancel-in-progress: false

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout source branch
        uses: actions/checkout@v4
        with:
          path: source

      - name: Checkout gh-pages branch
        uses: actions/checkout@v4
        with:
          ref: gh-pages
          path: gh-pages
        continue-on-error: true

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
          cache-dependency-path: source/package-lock.json

      - name: Install dependencies
        run: npm ci
        working-directory: source

      - name: Get repository name
        id: repo
        run: |
          REPO_NAME="${{ github.event.repository.name }}"
          echo "name=$REPO_NAME" >> $GITHUB_OUTPUT

      - name: Extract experiment name from branch
        id: extract
        run: |
          BRANCH="${GITHUB_REF#refs/heads/}"
          echo "branch=$BRANCH" >> $GITHUB_OUTPUT

          if [[ "$BRANCH" == "main" ]]; then
            echo "experiment_name=" >> $GITHUB_OUTPUT
            echo "base_path=/${{ steps.repo.outputs.name }}" >> $GITHUB_OUTPUT
            echo "is_main=true" >> $GITHUB_OUTPUT
          else
            # Keep FULL name (with session ID) for uniqueness - prevents collisions
            # e.g., claude/coaching-website-design-Px8p3 -> coaching-website-design-Px8p3
            FULL_NAME=$(echo "$BRANCH" | sed 's|^claude/||')
            echo "experiment_name=$FULL_NAME" >> $GITHUB_OUTPUT
            echo "base_path=/${{ steps.repo.outputs.name }}/$FULL_NAME" >> $GITHUB_OUTPUT
            echo "is_main=false" >> $GITHUB_OUTPUT
          fi

      - name: Build Next.js app
        run: npm run build
        working-directory: source
        env:
          NEXT_PUBLIC_BASE_PATH: ${{ steps.extract.outputs.base_path }}

      - name: Prepare deployment directory
        run: |
          mkdir -p deploy

          # Copy ALL existing gh-pages content if it exists
          if [ -d "gh-pages" ]; then
            echo "Copying existing gh-pages content..."
            find gh-pages -mindepth 1 -maxdepth 1 ! -name '.git' -exec cp -r {} deploy/ \;
            echo "Copied from gh-pages:"
            ls -la deploy/
          else
            echo "No existing gh-pages content found"
          fi

          touch deploy/.nojekyll

      - name: Deploy main branch (root)
        if: steps.extract.outputs.is_main == 'true'
        run: |
          echo "Deploying main branch to root..."

          # Save existing experiment directories
          mkdir -p temp-save
          for dir in deploy/*/; do
            if [ -d "$dir" ]; then
              dirname=$(basename "$dir")
              echo "Saving experiment directory: $dirname"
              cp -r "$dir" "temp-save/$dirname"
            fi
          done

          # Clear deploy and copy new build
          rm -rf deploy/*
          cp -r source/out/* deploy/

          # Restore experiment directories
          for dir in temp-save/*/; do
            if [ -d "$dir" ]; then
              dirname=$(basename "$dir")
              echo "Restoring experiment directory: $dirname"
              cp -r "$dir" "deploy/$dirname"
            fi
          done

          touch deploy/.nojekyll

      - name: Deploy experiment branch (subpath)
        if: steps.extract.outputs.is_main == 'false'
        run: |
          EXPERIMENT_NAME="${{ steps.extract.outputs.experiment_name }}"
          echo "Deploying experiment '$EXPERIMENT_NAME' to subpath..."

          # Remove old version of this experiment only
          rm -rf "deploy/$EXPERIMENT_NAME"

          # Copy new build to experiment folder
          mkdir -p "deploy/$EXPERIMENT_NAME"
          cp -r source/out/* "deploy/$EXPERIMENT_NAME/"

          echo "Experiment deployed to: deploy/$EXPERIMENT_NAME/"

      - name: Purge orphan experiments
        run: |
          cd source
          echo "Checking for orphan experiment folders..."

          # Get all remote branch names (claude/* branches)
          git fetch --all --quiet
          ACTIVE_EXPERIMENTS=$(git branch -r | grep 'origin/claude/' | sed 's|.*origin/claude/||' | sort)

          echo "Active experiment branches:"
          echo "$ACTIVE_EXPERIMENTS"

          cd ../deploy

          # List of directories to skip (Next.js infrastructure)
          SKIP_PATTERN="^(_next|_not-found|404|welcome|setup)"

          # Check each directory in deploy
          for dir in */; do
            if [ -d "$dir" ]; then
              dirname=$(basename "$dir")

              # Skip infrastructure directories
              if [[ "$dirname" =~ $SKIP_PATTERN ]] || [[ "$dirname" == *"setup"* ]]; then
                continue
              fi

              # Check if this experiment has a matching branch
              if echo "$ACTIVE_EXPERIMENTS" | grep -q "^${dirname}$"; then
                echo "Active: $dirname"
              else
                echo "ORPHAN: $dirname - removing..."
                rm -rf "$dirname"
              fi
            fi
          done

          echo ""
          echo "Remaining directories:"
          ls -la

      - name: Generate manifest dynamically
        run: |
          cd deploy
          echo "Generating manifest by scanning all experiment directories..."

          # Save old manifest to preserve creation dates
          OLD_MANIFEST="{}"
          if [ -f "manifest.json" ]; then
            OLD_MANIFEST=$(cat manifest.json)
          fi

          # Start fresh manifest
          echo '{"experiments":[]}' > manifest.json

          # List of directories to skip (Next.js infrastructure + setup branches)
          SKIP_DIRS="_next|_not-found|404|welcome|setup"

          # Current timestamp for new entries
          NOW=$(date -u +%Y-%m-%dT%H:%M:%SZ)

          # Scan all top-level directories for experiment folders
          for exp_dir in */; do
            if [ -d "$exp_dir" ]; then
              exp_name=$(basename "$exp_dir")

              # Skip infrastructure directories and setup branches
              if [[ "$exp_name" =~ ^($SKIP_DIRS) ]] || [[ "$exp_name" == *"setup"* ]]; then
                echo "Skipping: $exp_name"
                continue
              fi

              echo "Scanning experiment: $exp_name"

              # Look for actual pages inside this experiment
              for page_dir in "$exp_dir"/*/; do
                if [ -d "$page_dir" ]; then
                  page_name=$(basename "$page_dir")

                  # Skip Next.js infrastructure
                  if [[ "$page_name" =~ ^($SKIP_DIRS) ]]; then
                    continue
                  fi

                  # Check if it's a real page (has index.html)
                  if [ -f "$page_dir/index.html" ]; then
                    PAGE_PATH="/$exp_name/$page_name"

                    # Create friendly display name:
                    # 1. Use page name, remove session ID suffix if present
                    # 2. Convert hyphens to spaces, capitalize words
                    FRIENDLY_NAME=$(echo "$page_name" | sed 's|-[a-zA-Z0-9]*$||' | sed 's/-/ /g' | awk '{for(i=1;i<=NF;i++) $i=toupper(substr($i,1,1)) substr($i,2)}1')

                    # Try to get creation date from old manifest, otherwise use now
                    CREATED_AT=$(echo "$OLD_MANIFEST" | jq -r ".experiments[] | select(.path == \"$PAGE_PATH\") | .createdAt // empty" 2>/dev/null)
                    if [ -z "$CREATED_AT" ]; then
                      CREATED_AT="$NOW"
                    fi

                    echo "  Found page: $PAGE_PATH ($FRIENDLY_NAME) - created: $CREATED_AT"

                    # Add to manifest with creation date
                    jq ".experiments += [{\"name\": \"$FRIENDLY_NAME\", \"path\": \"$PAGE_PATH\", \"createdAt\": \"$CREATED_AT\"}]" manifest.json > manifest.tmp && mv manifest.tmp manifest.json
                  fi
                fi
              done
            fi
          done

          echo ""
          echo "Generated manifest:"
          cat manifest.json

      - name: Push to gh-pages
        uses: peaceiris/actions-gh-pages@v4
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          publish_dir: ./deploy
          keep_files: false
