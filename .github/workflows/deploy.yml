name: Deploy to GitHub Pages

on:
  push:
    branches:
      - main
      - 'claude/**'
  workflow_dispatch:

permissions:
  contents: write
  pages: write
  id-token: write

# Use a single concurrency group for all deployments to prevent race conditions
concurrency:
  group: "pages-deployment"
  cancel-in-progress: false

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout source branch
        uses: actions/checkout@v4
        with:
          path: source

      - name: Checkout gh-pages branch
        uses: actions/checkout@v4
        with:
          ref: gh-pages
          path: gh-pages
        continue-on-error: true

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
          cache-dependency-path: source/package-lock.json

      - name: Install dependencies
        run: npm ci
        working-directory: source

      - name: Get repository name
        id: repo
        run: |
          REPO_NAME="${{ github.event.repository.name }}"
          echo "name=$REPO_NAME" >> $GITHUB_OUTPUT

      - name: Extract experiment name from branch
        id: extract
        run: |
          BRANCH="${GITHUB_REF#refs/heads/}"
          echo "branch=$BRANCH" >> $GITHUB_OUTPUT

          if [[ "$BRANCH" == "main" ]]; then
            # Main branch deploys to root with repo name as base
            echo "experiment_name=" >> $GITHUB_OUTPUT
            echo "base_path=/${{ steps.repo.outputs.name }}" >> $GITHUB_OUTPUT
            echo "is_main=true" >> $GITHUB_OUTPUT
          else
            # Extract name from claude/name-sessionId pattern
            # Remove 'claude/' prefix and the session ID suffix (last hyphen + alphanumeric)
            NAME=$(echo "$BRANCH" | sed 's|^claude/||' | sed 's|-[a-zA-Z0-9]*$||')
            echo "experiment_name=$NAME" >> $GITHUB_OUTPUT
            echo "base_path=/${{ steps.repo.outputs.name }}/$NAME" >> $GITHUB_OUTPUT
            echo "is_main=false" >> $GITHUB_OUTPUT
          fi

      - name: Build Next.js app
        run: npm run build
        working-directory: source
        env:
          NEXT_PUBLIC_BASE_PATH: ${{ steps.extract.outputs.base_path }}

      - name: Prepare deployment directory
        run: |
          mkdir -p deploy

          # Copy ALL existing gh-pages content if it exists (preserve experiments even if root is broken)
          if [ -d "gh-pages" ]; then
            echo "Copying existing gh-pages content..."
            # Copy everything except .git
            find gh-pages -mindepth 1 -maxdepth 1 ! -name '.git' -exec cp -r {} deploy/ \;
            echo "Copied from gh-pages:"
            ls -la deploy/
          else
            echo "No existing gh-pages content found"
          fi

          # Ensure .nojekyll exists
          touch deploy/.nojekyll

          # List what we have so far
          echo "Current deploy directory contents:"
          ls -la deploy/

      - name: Deploy main branch (root)
        if: steps.extract.outputs.is_main == 'true'
        run: |
          echo "Deploying main branch to root..."

          # Save existing experiment directories and manifest
          mkdir -p temp-save
          for dir in deploy/*/; do
            if [ -d "$dir" ]; then
              dirname=$(basename "$dir")
              echo "Saving experiment directory: $dirname"
              cp -r "$dir" "temp-save/$dirname"
            fi
          done

          if [ -f deploy/manifest.json ]; then
            echo "Saving manifest.json"
            cp deploy/manifest.json temp-save/manifest.json
          fi

          # Clear deploy and copy new build
          rm -rf deploy/*
          cp -r source/out/* deploy/

          # Restore experiment directories
          for dir in temp-save/*/; do
            if [ -d "$dir" ]; then
              dirname=$(basename "$dir")
              echo "Restoring experiment directory: $dirname"
              cp -r "$dir" "deploy/$dirname"
            fi
          done

          # Restore manifest (merge with any new content)
          if [ -f temp-save/manifest.json ]; then
            echo "Restoring manifest.json"
            cp temp-save/manifest.json deploy/manifest.json
          fi

          touch deploy/.nojekyll

          echo "Final deploy directory contents:"
          ls -la deploy/

      - name: Deploy experiment branch (subpath)
        if: steps.extract.outputs.is_main == 'false'
        run: |
          EXPERIMENT_NAME="${{ steps.extract.outputs.experiment_name }}"
          echo "Deploying experiment '$EXPERIMENT_NAME' to subpath..."

          # Verify we have the root content
          if [ ! -f "deploy/index.html" ]; then
            echo "WARNING: Root index.html not found in deploy directory!"
            echo "This might indicate gh-pages checkout failed."
            echo "Deploy directory contents:"
            ls -la deploy/
          fi

          # Remove old version of this experiment only
          rm -rf "deploy/$EXPERIMENT_NAME"

          # Copy new build to experiment folder
          mkdir -p "deploy/$EXPERIMENT_NAME"
          cp -r source/out/* "deploy/$EXPERIMENT_NAME/"

          echo "Final deploy directory contents:"
          ls -la deploy/
          echo "Experiment directory contents:"
          ls -la "deploy/$EXPERIMENT_NAME/" | head -20

      - name: Update manifest for experiment
        if: steps.extract.outputs.is_main == 'false'
        run: |
          EXPERIMENT_NAME="${{ steps.extract.outputs.experiment_name }}"
          CREATED_AT=$(date -u +%Y-%m-%dT%H:%M:%SZ)

          cd deploy

          # Skip setup/infrastructure branches - they're not real experiments
          if [[ "$EXPERIMENT_NAME" == *"setup"* ]]; then
            echo "Skipping setup branch - not adding to manifest"
            exit 0
          fi

          # Create manifest if it doesn't exist
          if [ ! -f "manifest.json" ]; then
            echo '{"experiments":[]}' > manifest.json
          fi

          # Find actual pages created in this experiment (not Next.js infrastructure)
          # Look for directories with index.html that aren't system directories
          EXPERIMENT_DIR="$EXPERIMENT_NAME"
          echo "Scanning $EXPERIMENT_DIR for pages..."

          for page_dir in "$EXPERIMENT_DIR"/*/; do
            if [ -d "$page_dir" ]; then
              page_name=$(basename "$page_dir")

              # Skip Next.js infrastructure directories
              if [[ "$page_name" == "_next" ]] || [[ "$page_name" == "_not-found" ]] || [[ "$page_name" == "404" ]] || [[ "$page_name" == "welcome" ]]; then
                continue
              fi

              # Check if it has an index.html (is a real page)
              if [ -f "$page_dir/index.html" ]; then
                PAGE_PATH="/$EXPERIMENT_NAME/$page_name"

                # Create pretty name from page name
                PRETTY_NAME=$(echo "$page_name" | sed 's/-/ /g' | awk '{for(i=1;i<=NF;i++) $i=toupper(substr($i,1,1)) substr($i,2)}1')

                echo "Found page: $page_name -> $PAGE_PATH ($PRETTY_NAME)"

                # Check if this page already exists in manifest
                if jq -e ".experiments[] | select(.path == \"$PAGE_PATH\")" manifest.json > /dev/null 2>&1; then
                  echo "Page already in manifest, updating timestamp"
                  jq ".experiments = [.experiments[] | if .path == \"$PAGE_PATH\" then .updatedAt = \"$CREATED_AT\" else . end]" manifest.json > manifest.tmp && mv manifest.tmp manifest.json
                else
                  echo "Adding new page to manifest"
                  jq ".experiments += [{\"name\": \"$PRETTY_NAME\", \"path\": \"$PAGE_PATH\", \"createdAt\": \"$CREATED_AT\"}]" manifest.json > manifest.tmp && mv manifest.tmp manifest.json
                fi
              fi
            fi
          done

          echo "Updated manifest:"
          cat manifest.json

      - name: Push to gh-pages
        uses: peaceiris/actions-gh-pages@v4
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          publish_dir: ./deploy
          keep_files: false
