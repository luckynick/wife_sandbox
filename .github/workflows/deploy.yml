name: Deploy to GitHub Pages

on:
  push:
    branches:
      - main
      - 'claude/**'
  workflow_dispatch:

permissions:
  contents: write
  pages: write
  id-token: write

# Use a single concurrency group for all deployments to prevent race conditions
concurrency:
  group: "pages-deployment"
  cancel-in-progress: false

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout source branch
        uses: actions/checkout@v4
        with:
          path: source

      - name: Checkout gh-pages branch
        uses: actions/checkout@v4
        with:
          ref: gh-pages
          path: gh-pages
        continue-on-error: true

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
          cache-dependency-path: source/package-lock.json

      - name: Install dependencies
        run: npm ci
        working-directory: source

      - name: Get repository name
        id: repo
        run: |
          REPO_NAME="${{ github.event.repository.name }}"
          echo "name=$REPO_NAME" >> $GITHUB_OUTPUT

      - name: Extract experiment name from branch
        id: extract
        run: |
          BRANCH="${GITHUB_REF#refs/heads/}"
          echo "branch=$BRANCH" >> $GITHUB_OUTPUT

          if [[ "$BRANCH" == "main" ]]; then
            echo "experiment_name=" >> $GITHUB_OUTPUT
            echo "base_path=/${{ steps.repo.outputs.name }}" >> $GITHUB_OUTPUT
            echo "is_main=true" >> $GITHUB_OUTPUT
          else
            # Extract name from claude/name-sessionId pattern
            NAME=$(echo "$BRANCH" | sed 's|^claude/||' | sed 's|-[a-zA-Z0-9]*$||')
            echo "experiment_name=$NAME" >> $GITHUB_OUTPUT
            echo "base_path=/${{ steps.repo.outputs.name }}/$NAME" >> $GITHUB_OUTPUT
            echo "is_main=false" >> $GITHUB_OUTPUT
          fi

      - name: Build Next.js app
        run: npm run build
        working-directory: source
        env:
          NEXT_PUBLIC_BASE_PATH: ${{ steps.extract.outputs.base_path }}

      - name: Prepare deployment directory
        run: |
          mkdir -p deploy

          # Copy ALL existing gh-pages content if it exists
          if [ -d "gh-pages" ]; then
            echo "Copying existing gh-pages content..."
            find gh-pages -mindepth 1 -maxdepth 1 ! -name '.git' -exec cp -r {} deploy/ \;
            echo "Copied from gh-pages:"
            ls -la deploy/
          else
            echo "No existing gh-pages content found"
          fi

          touch deploy/.nojekyll

      - name: Deploy main branch (root)
        if: steps.extract.outputs.is_main == 'true'
        run: |
          echo "Deploying main branch to root..."

          # Save existing experiment directories
          mkdir -p temp-save
          for dir in deploy/*/; do
            if [ -d "$dir" ]; then
              dirname=$(basename "$dir")
              echo "Saving experiment directory: $dirname"
              cp -r "$dir" "temp-save/$dirname"
            fi
          done

          # Clear deploy and copy new build
          rm -rf deploy/*
          cp -r source/out/* deploy/

          # Restore experiment directories
          for dir in temp-save/*/; do
            if [ -d "$dir" ]; then
              dirname=$(basename "$dir")
              echo "Restoring experiment directory: $dirname"
              cp -r "$dir" "deploy/$dirname"
            fi
          done

          touch deploy/.nojekyll

      - name: Deploy experiment branch (subpath)
        if: steps.extract.outputs.is_main == 'false'
        run: |
          EXPERIMENT_NAME="${{ steps.extract.outputs.experiment_name }}"
          echo "Deploying experiment '$EXPERIMENT_NAME' to subpath..."

          # Remove old version of this experiment only
          rm -rf "deploy/$EXPERIMENT_NAME"

          # Copy new build to experiment folder
          mkdir -p "deploy/$EXPERIMENT_NAME"
          cp -r source/out/* "deploy/$EXPERIMENT_NAME/"

          echo "Experiment deployed to: deploy/$EXPERIMENT_NAME/"

      - name: Generate manifest dynamically
        run: |
          cd deploy
          echo "Generating manifest by scanning all experiment directories..."

          # Start fresh manifest
          echo '{"experiments":[]}' > manifest.json

          # List of directories to skip (Next.js infrastructure + setup branches)
          SKIP_DIRS="_next|_not-found|404|welcome|setup"

          # Scan all top-level directories for experiment folders
          for exp_dir in */; do
            if [ -d "$exp_dir" ]; then
              exp_name=$(basename "$exp_dir")

              # Skip infrastructure directories and setup branches
              if [[ "$exp_name" =~ ^($SKIP_DIRS) ]] || [[ "$exp_name" == *"setup"* ]]; then
                echo "Skipping: $exp_name"
                continue
              fi

              echo "Scanning experiment: $exp_name"

              # Look for actual pages inside this experiment
              for page_dir in "$exp_dir"/*/; do
                if [ -d "$page_dir" ]; then
                  page_name=$(basename "$page_dir")

                  # Skip Next.js infrastructure
                  if [[ "$page_name" =~ ^($SKIP_DIRS) ]]; then
                    continue
                  fi

                  # Check if it's a real page (has index.html)
                  if [ -f "$page_dir/index.html" ]; then
                    PAGE_PATH="/$exp_name/$page_name"

                    # Create pretty name from page name
                    PRETTY_NAME=$(echo "$page_name" | sed 's/-/ /g' | awk '{for(i=1;i<=NF;i++) $i=toupper(substr($i,1,1)) substr($i,2)}1')

                    echo "  Found page: $PAGE_PATH ($PRETTY_NAME)"

                    # Add to manifest
                    jq ".experiments += [{\"name\": \"$PRETTY_NAME\", \"path\": \"$PAGE_PATH\"}]" manifest.json > manifest.tmp && mv manifest.tmp manifest.json
                  fi
                fi
              done
            fi
          done

          echo ""
          echo "Generated manifest:"
          cat manifest.json

      - name: Push to gh-pages
        uses: peaceiris/actions-gh-pages@v4
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          publish_dir: ./deploy
          keep_files: false
