name: Deploy to GitHub Pages

on:
  push:
    branches:
      - main
      - 'claude/**'
  workflow_dispatch:

permissions:
  contents: write
  pages: write
  id-token: write

# Use a single concurrency group for all deployments to prevent race conditions
concurrency:
  group: "pages-deployment"
  cancel-in-progress: false

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout source branch
        uses: actions/checkout@v4
        with:
          path: source

      - name: Checkout gh-pages branch
        uses: actions/checkout@v4
        with:
          ref: gh-pages
          path: gh-pages
        continue-on-error: true

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
          cache-dependency-path: source/package-lock.json

      - name: Install dependencies
        run: npm ci
        working-directory: source

      - name: Get repository name
        id: repo
        run: |
          REPO_NAME="${{ github.event.repository.name }}"
          echo "name=$REPO_NAME" >> $GITHUB_OUTPUT

      - name: Extract experiment name from branch
        id: extract
        run: |
          BRANCH="${GITHUB_REF#refs/heads/}"
          echo "branch=$BRANCH" >> $GITHUB_OUTPUT

          if [[ "$BRANCH" == "main" ]]; then
            # Main branch deploys to root with repo name as base
            echo "experiment_name=" >> $GITHUB_OUTPUT
            echo "base_path=/${{ steps.repo.outputs.name }}" >> $GITHUB_OUTPUT
            echo "is_main=true" >> $GITHUB_OUTPUT
          else
            # Extract name from claude/name-sessionId pattern
            # Remove 'claude/' prefix and the session ID suffix (last hyphen + alphanumeric)
            NAME=$(echo "$BRANCH" | sed 's|^claude/||' | sed 's|-[a-zA-Z0-9]*$||')
            echo "experiment_name=$NAME" >> $GITHUB_OUTPUT
            echo "base_path=/${{ steps.repo.outputs.name }}/$NAME" >> $GITHUB_OUTPUT
            echo "is_main=false" >> $GITHUB_OUTPUT
          fi

      - name: Build Next.js app
        run: npm run build
        working-directory: source
        env:
          NEXT_PUBLIC_BASE_PATH: ${{ steps.extract.outputs.base_path }}

      - name: Prepare deployment directory
        run: |
          mkdir -p deploy

          # Copy ALL existing gh-pages content if it exists (preserve experiments even if root is broken)
          if [ -d "gh-pages" ]; then
            echo "Copying existing gh-pages content..."
            # Copy everything except .git
            find gh-pages -mindepth 1 -maxdepth 1 ! -name '.git' -exec cp -r {} deploy/ \;
            echo "Copied from gh-pages:"
            ls -la deploy/
          else
            echo "No existing gh-pages content found"
          fi

          # Ensure .nojekyll exists
          touch deploy/.nojekyll

          # List what we have so far
          echo "Current deploy directory contents:"
          ls -la deploy/

      - name: Deploy main branch (root)
        if: steps.extract.outputs.is_main == 'true'
        run: |
          echo "Deploying main branch to root..."

          # Save existing experiment directories and manifest
          mkdir -p temp-save
          for dir in deploy/*/; do
            if [ -d "$dir" ]; then
              dirname=$(basename "$dir")
              echo "Saving experiment directory: $dirname"
              cp -r "$dir" "temp-save/$dirname"
            fi
          done

          if [ -f deploy/manifest.json ]; then
            echo "Saving manifest.json"
            cp deploy/manifest.json temp-save/manifest.json
          fi

          # Clear deploy and copy new build
          rm -rf deploy/*
          cp -r source/out/* deploy/

          # Restore experiment directories
          for dir in temp-save/*/; do
            if [ -d "$dir" ]; then
              dirname=$(basename "$dir")
              echo "Restoring experiment directory: $dirname"
              cp -r "$dir" "deploy/$dirname"
            fi
          done

          # Restore manifest (merge with any new content)
          if [ -f temp-save/manifest.json ]; then
            echo "Restoring manifest.json"
            cp temp-save/manifest.json deploy/manifest.json
          fi

          touch deploy/.nojekyll

          echo "Final deploy directory contents:"
          ls -la deploy/

      - name: Deploy experiment branch (subpath)
        if: steps.extract.outputs.is_main == 'false'
        run: |
          EXPERIMENT_NAME="${{ steps.extract.outputs.experiment_name }}"
          echo "Deploying experiment '$EXPERIMENT_NAME' to subpath..."

          # Verify we have the root content
          if [ ! -f "deploy/index.html" ]; then
            echo "WARNING: Root index.html not found in deploy directory!"
            echo "This might indicate gh-pages checkout failed."
            echo "Deploy directory contents:"
            ls -la deploy/
          fi

          # Remove old version of this experiment only
          rm -rf "deploy/$EXPERIMENT_NAME"

          # Copy new build to experiment folder
          mkdir -p "deploy/$EXPERIMENT_NAME"
          cp -r source/out/* "deploy/$EXPERIMENT_NAME/"

          echo "Final deploy directory contents:"
          ls -la deploy/
          echo "Experiment directory contents:"
          ls -la "deploy/$EXPERIMENT_NAME/" | head -20

      - name: Update manifest for experiment
        if: steps.extract.outputs.is_main == 'false'
        run: |
          EXPERIMENT_NAME="${{ steps.extract.outputs.experiment_name }}"
          EXPERIMENT_PATH="/$EXPERIMENT_NAME"

          cd deploy

          # Create manifest if it doesn't exist
          if [ ! -f "manifest.json" ]; then
            echo '{"experiments":[]}' > manifest.json
          fi

          # Check if experiment already exists in manifest
          if grep -q "\"path\": \"$EXPERIMENT_PATH\"" manifest.json; then
            echo "Experiment already in manifest"
          else
            echo "Adding new experiment to manifest"
            # Create pretty name from experiment name
            PRETTY_NAME=$(echo "$EXPERIMENT_NAME" | sed 's/-/ /g' | awk '{for(i=1;i<=NF;i++) $i=toupper(substr($i,1,1)) substr($i,2)}1')

            # Use sed to add new entry (more portable than jq)
            if grep -q '"experiments":\[\]' manifest.json; then
              # Empty array - replace with new entry
              sed -i "s|\"experiments\":\[\]|\"experiments\":[{\"name\": \"$PRETTY_NAME\", \"path\": \"$EXPERIMENT_PATH\", \"createdAt\": \"$(date -u +%Y-%m-%dT%H:%M:%SZ)\"}]|" manifest.json
            else
              # Has entries - add to array
              sed -i "s|\"experiments\":\[|\"experiments\":[{\"name\": \"$PRETTY_NAME\", \"path\": \"$EXPERIMENT_PATH\", \"createdAt\": \"$(date -u +%Y-%m-%dT%H:%M:%SZ)\"},|" manifest.json
            fi
          fi

          echo "Updated manifest:"
          cat manifest.json

      - name: Push to gh-pages
        uses: peaceiris/actions-gh-pages@v4
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          publish_dir: ./deploy
          keep_files: false
